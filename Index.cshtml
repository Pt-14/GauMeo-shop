@{
    ViewData["Title"] = ViewBag.Title;
    var products = ViewBag.Products as List<dynamic>;
    var categories = ViewBag.Categories as List<dynamic>;
    var animalType = ViewBag.AnimalType as string;
    var categoryGroup = ViewBag.CategoryGroup as string;
    var animalPageUrl = ViewBag.AnimalPageUrl as string;
    var animalPageName = ViewBag.AnimalPageName as string;
    var showAllCategories = ViewBag.ShowAllCategories as bool? ?? false;
    var categoryGroupName = ViewBag.CategoryGroupName as string;
    var brands = ViewBag.Brands as List<string>;
    var currentFilters = ViewBag.CurrentFilters;
}

@section Styles {
    <link rel="stylesheet" href="~/css/product-index.css" asp-append-version="true" />
    <style>
        .filters-panel {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .filters-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }
        .filters-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        .clear-filters-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            color: #6c757d;
            cursor: pointer;
        }
        .clear-filters-btn:hover {
            background: #e9ecef;
        }
        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .filter-group {
            display: flex;
            flex-direction: column;
        }
        .filter-label {
            font-weight: 500;
            margin-bottom: 5px;
            color: #495057;
            font-size: 14px;
        }
        .filter-select, .filter-checkbox {
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        .filter-select:focus {
            outline: none;
            border-color: #80bdff;
            box-shadow: 0 0 0 2px rgba(0,123,255,.25);
        }
        .active-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }
        .filter-tag {
            background: #007bff;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .filter-tag .remove {
            cursor: pointer;
            font-weight: bold;
        }
        .mobile-filter-toggle {
            display: none;
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        @@media (max-width: 768px) {
            .mobile-filter-toggle {
                display: block;
            }
            .filters-panel {
                display: none;
            }
            .filters-panel.show {
                display: block;
            }
            .filters-grid {
                grid-template-columns: 1fr;
            }
            .product-layout {
                flex-direction: column;
            }
            .categories-sidebar {
                order: 2;
                margin-top: 20px;
            }
        }
    </style>
}

<div class="product-index-container">
    <div class="breadcrumb">
        <a href="/Home/Index">Trang chủ</a> / 
        @if (!string.IsNullOrEmpty(categoryGroup))
        {
            <a href="@animalPageUrl">@animalPageName</a><text> / </text><span>@ViewBag.Title</span>
        }
        else
        {
            <span>@ViewBag.Title</span>
        }
    </div>
    
    <div class="product-index-header">
        <h1 class="product-index-title">@ViewBag.Title</h1>
        <div class="product-index-subtitle">
            @if (animalType == "dog")
            {
                <span>Khám phá bộ sưu tập sản phẩm dành riêng cho chó cưng với chất lượng tuyệt vời từ các thương hiệu hàng đầu thế giới. Từ thức ăn dinh dưỡng, đồ chơi vui nhộn đến phụ kiện chăm sóc - tất cả đều được tuyển chọn kỹ lưỡng.</span>
            }
            else
            {
                <span>Tìm hiểu những sản phẩm tuyệt vời dành cho mèo cưng với đa dạng lựa chọn từ thức ăn cao cấp, đồ chơi thông minh đến các sản phẩm chăm sóc chuyên biệt. Mang đến cuộc sống tốt đẹp nhất cho boss nhà bạn.</span>
            }
        </div>
    </div>

    <!-- Category Navigation -->
    @if (categories != null && categories.Count > 0)
    {
        <div class="product-category-navigation">
            <div class="product-category-nav-arrow" id="categoryScrollLeft">
                <i class="fas fa-chevron-left"></i>
            </div>
            <div class="product-category-scroll-container">
                <div class="product-category-grid @(categories.Count <= 7 ? "center-categories" : "")" id="categoryGrid">
                    @foreach (var category in categories)
                    {
                        var categoryUrl = showAllCategories ? category.Url : $"/Product/{(animalType == "dog" ? "Dog" : "Cat")}Category?category={category.Id}";
                        <a href="@categoryUrl" class="product-category-item">
                            <div class="product-category-icon">
                                @category.Icon
                            </div>
                            <div class="product-category-name">@category.Name</div>
                        </a>
                    }
                </div>
            </div>
            <div class="product-category-nav-arrow" id="categoryScrollRight">
                <i class="fas fa-chevron-right"></i>
            </div>
        </div>
    }

    <!-- Mobile Filter Toggle -->
    <button class="product-mobile-filter-toggle" onclick="toggleFilters()">
        <i class="fas fa-filter"></i> Bộ lọc sản phẩm
    </button>

    <!-- Main Layout with Left Sidebar -->
    <div class="product-main-layout">
        <!-- Left Sidebar Filters -->
        <div class="product-filters-sidebar" id="filtersSidebar">
            <h3 class="product-filters-title">
                <i class="fas fa-filter"></i> Bộ lọc sản phẩm
            </h3>
            
            <button class="product-clear-filters-btn" onclick="clearAllFilters()">
                <i class="fas fa-times"></i> Xóa tất cả bộ lọc
            </button>
        
            <form id="filterForm" method="get">
                <!-- Brand Filter -->
                <div class="product-filter-section">
                    <h4 class="product-filter-section-title">
                        <i class="fas fa-tag"></i> Thương hiệu
                    </h4>
                    <div class="product-brand-search">
                        <input type="text" class="product-brand-search-input" id="brandSearchInput" placeholder="Tìm thương hiệu..." autocomplete="off">
                    </div>
                    <div class="product-brand-options" id="brandOptions">
                        <div class="product-filter-options">
                            @if (brands != null)
                            {
                                @foreach (var brand in brands)
                                {
                                    <label class="product-filter-option brand-option" data-brand="@brand.ToLower()">
                                        <input type="checkbox" name="brands" value="@brand" class="product-filter-checkbox brand-checkbox">
                                        <span class="product-filter-label-text">@brand</span>
                                        <span class="product-filter-count">(5)</span>
                                    </label>
                                }
                            }
                        </div>
                    </div>
                </div>
                
                <!-- Price Range Filter -->
                <div class="product-filter-section">
                    <h4 class="product-filter-section-title">
                        <i class="fas fa-dollar-sign"></i> Khoảng giá
                    </h4>
                    <div class="product-filter-options">
                        <label class="product-filter-option">
                            <input type="radio" name="priceRange" value="0-100000" class="product-filter-radio">
                            <span class="product-filter-label-text">Dưới 100.000đ</span>
                            <span class="product-filter-count">(15)</span>
                        </label>
                        <label class="product-filter-option">
                            <input type="radio" name="priceRange" value="100000-300000" class="product-filter-radio">
                            <span class="product-filter-label-text">100.000đ - 300.000đ</span>
                            <span class="product-filter-count">(25)</span>
                        </label>
                        <label class="product-filter-option">
                            <input type="radio" name="priceRange" value="300000-500000" class="product-filter-radio">
                            <span class="product-filter-label-text">300.000đ - 500.000đ</span>
                            <span class="product-filter-count">(18)</span>
                        </label>
                        <label class="product-filter-option">
                            <input type="radio" name="priceRange" value="500000-1000000" class="product-filter-radio">
                            <span class="product-filter-label-text">500.000đ - 1.000.000đ</span>
                            <span class="product-filter-count">(12)</span>
                        </label>
                        <label class="product-filter-option">
                            <input type="radio" name="priceRange" value="1000000-0" class="product-filter-radio">
                            <span class="product-filter-label-text">Trên 1.000.000đ</span>
                            <span class="product-filter-count">(8)</span>
                        </label>
                    </div>
                    <div class="product-price-range-inputs">
                        <input type="number" placeholder="Từ" class="product-price-input" id="priceMin">
                        <span class="product-price-separator">-</span>
                        <input type="number" placeholder="Đến" class="product-price-input" id="priceMax">
                    </div>
                </div>
                
                <!-- Rating Filter -->
                <div class="product-filter-section">
                    <h4 class="product-filter-section-title">
                        <i class="fas fa-star"></i> Đánh giá
                    </h4>
                    <div class="product-filter-options">
                        <label class="product-rating-option">
                            <input type="radio" name="rating" value="4.5" class="product-filter-radio">
                            <div class="product-rating-stars">
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                            </div>
                            <span class="product-filter-label-text">4.5★ trở lên</span>
                        </label>
                        <label class="product-rating-option">
                            <input type="radio" name="rating" value="4.0" class="product-filter-radio">
                            <div class="product-rating-stars">
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star empty">★</span>
                            </div>
                            <span class="product-filter-label-text">4.0★ trở lên</span>
                        </label>
                        <label class="product-rating-option">
                            <input type="radio" name="rating" value="3.5" class="product-filter-radio">
                            <div class="product-rating-stars">
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star empty">★</span>
                                <span class="product-rating-star empty">★</span>
                            </div>
                            <span class="product-filter-label-text">3.5★ trở lên</span>
                        </label>
                    </div>
                </div>

                <!-- Promotion Filter -->
                <div class="product-filter-section">
                    <h4 class="product-filter-section-title">
                        <i class="fas fa-percent"></i> Khuyến mãi
                    </h4>
                    <div class="product-filter-options">
                        <label class="product-filter-option">
                            <input type="checkbox" name="onSale" value="true" class="product-filter-checkbox">
                            <span class="product-filter-label-text">Đang giảm giá</span>
                            <span class="product-filter-count">(12)</span>
                        </label>
                        <label class="product-filter-option">
                            <input type="checkbox" name="freeShipping" value="true" class="product-filter-checkbox">
                            <span class="product-filter-label-text">Miễn phí vận chuyển</span>
                            <span class="product-filter-count">(8)</span>
                        </label>
                    </div>
                </div>

                <!-- Active Filters -->
                <div class="product-active-filters" id="activeFilters">
                    <div class="product-active-filters-title">Bộ lọc đang áp dụng:</div>
                    <div class="product-active-filter-tags" id="activeFilterTags">
                        <!-- Active filter tags will be inserted here by JavaScript -->
                    </div>
                </div>
            </form>
        </div>

        <!-- Products Content -->
        <div class="product-content">
            <div class="product-header">
                <div class="product-info">
                    <h2 class="products-title">Tìm thấy @products.Count sản phẩm</h2>
                    <p class="product-description">Các sản phẩm chất lượng được lựa chọn kỹ lưỡng</p>
                    <div class="product-content-active-filters">
                        <div class="product-active-filters" id="productsActiveFilters">
                            <div class="product-active-filters-title">Đang lọc theo:</div>
                            <div class="product-active-filter-tags" id="productsActiveFilterTags">
                                <!-- Active filter tags will be inserted here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="product-controls">
                    <div class="product-sort-controls">
                        <label>Sắp xếp theo:</label>
                        <select name="sort" class="product-sort-select" onchange="applyFilters()">
                            <option value="popular">Phổ biến nhất</option>
                            <option value="price-asc">Giá tăng dần</option>
                            <option value="price-desc">Giá giảm dần</option>
                            <option value="name-asc">Tên A-Z</option>
                            <option value="name-desc">Tên Z-A</option>
                            <option value="rating">Đánh giá cao nhất</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Products Grid -->
            @if (products != null && products.Count > 0)
            {
                <div class="product-grid">
                    @foreach (var product in products)
                    {
                        <div class="product-card" data-product-id="@product.Id">
                            <div class="product-image">
                                <img src="@product.Image" alt="@product.Name" loading="lazy">
                                @if (product.IsOnSale)
                                {
                                    <div class="product-sale-badge">-@product.DiscountPercent%</div>
                                }
                                <div class="product-actions-overlay">
                                    <button class="product-quick-view-btn" title="Xem nhanh">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="product-add-to-wishlist-btn" title="Yêu thích">
                                        <i class="far fa-heart"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="product-info">
                                <div class="product-brand">@product.Brand</div>
                                <h3 class="product-name">@product.Name</h3>
                                <div class="product-rating">
                                    @for (int i = 1; i <= 5; i++)
                                    {
                                        <i class="fas fa-star @(i <= product.Rating ? "active" : "")"></i>
                                    }
                                    <span class="product-rating-text">(@product.Rating)</span>
                                </div>
                                <div class="product-price">
                                    @if (product.IsOnSale)
                                    {
                                        <span class="product-original-price">@product.Price.ToString("N0")đ</span>
                                        <span class="product-current-price">@((product.Price * (100 - product.DiscountPercent) / 100).ToString("N0"))đ</span>
                                    }
                                    else
                                    {
                                        <span class="product-current-price">@product.Price.ToString("N0")đ</span>
                                    }
                                </div>
                                <button class="product-add-to-cart-btn" onclick="addToCart(@product.Id)">
                                    <i class="fas fa-shopping-cart"></i> Thêm vào giỏ
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="product-no-products" style="display: none;">
                    <i class="fas fa-search"></i>
                    <h3>Không tìm thấy sản phẩm</h3>
                    <p>Không có sản phẩm nào phù hợp với tiêu chí tìm kiếm của bạn.</p>
                    <button class="product-back-to-all-btn" onclick="clearAllFilters()">
                        <i class="fas fa-arrow-left"></i> Xem tất cả sản phẩm
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Category Navigation Scroll - Show 7 items at a time with center logic
        document.addEventListener('DOMContentLoaded', function() {
            const categoryGrid = document.getElementById('categoryGrid');
            const leftArrow = document.getElementById('categoryScrollLeft');
            const rightArrow = document.getElementById('categoryScrollRight');
            
            if (categoryGrid && leftArrow && rightArrow) {
                // Calculate scroll amount for 7 items (item width + gap)
                const itemWidth = 120; // width of each category card
                const gap = 20; // gap between cards  
                const scrollAmount = (itemWidth + gap) * 2; // Scroll 2 items at a time for smoother experience
                
                function updateArrows() {
                    const scrollLeft = categoryGrid.scrollLeft;
                    const maxScroll = categoryGrid.scrollWidth - categoryGrid.clientWidth;
                    const totalItems = categoryGrid.children.length;
                    const hasCenterClass = categoryGrid.classList.contains('center-categories');
                    
                    // Hide arrows if 7 or fewer items (will be centered) or no overflow
                    if (maxScroll <= 0 || hasCenterClass || totalItems <= 7) {
                        leftArrow.style.display = 'none';
                        rightArrow.style.display = 'none';
                        return;
                    } else {
                        leftArrow.style.display = 'flex';
                        rightArrow.style.display = 'flex';
                    }
                    
                    leftArrow.classList.toggle('disabled', scrollLeft <= 0);
                    rightArrow.classList.toggle('disabled', scrollLeft >= maxScroll - 1);
                }
                
                function scrollLeft() {
                    categoryGrid.scrollBy({
                        left: -scrollAmount,
                        behavior: 'smooth'
                    });
                }
                
                function scrollRight() {
                    categoryGrid.scrollBy({
                        left: scrollAmount,
                        behavior: 'smooth'
                    });
                }
                
                leftArrow.addEventListener('click', scrollLeft);
                rightArrow.addEventListener('click', scrollRight);
                categoryGrid.addEventListener('scroll', updateArrows);
                
                // Initial arrow state
                updateArrows();
                
                // Update arrows on window resize
                window.addEventListener('resize', function() {
                    setTimeout(updateArrows, 100);
                });
            }
        });

        // Mobile filter toggle
        function toggleFilters() {
            const sidebar = document.getElementById('filtersSidebar');
            sidebar.classList.toggle('show');
        }

        // Filter logic with validation
        let activeFilters = {
            brands: [],
            priceRange: null,
            rating: null,
            promotions: []
        };

        // Store original products for reset functionality
        let originalProducts = [];

        // Initialize filters from current state
        document.addEventListener('DOMContentLoaded', function() {
            // Store original products when page loads
            const productCards = document.querySelectorAll('.product-card');
            originalProducts = Array.from(productCards).map(card => card.cloneNode(true));
            
            updateActiveFilters();
            attachFilterListeners();
            initializeBrandSearch();
            
            // Initialize from URL parameters if any
            const urlParams = new URLSearchParams(window.location.search);
            const brands = urlParams.getAll('brand');
            const priceRange = urlParams.get('priceRange');
            const rating = urlParams.get('rating');
            const onSale = urlParams.get('onSale');
            const freeShipping = urlParams.get('freeShipping');
            const sort = urlParams.get('sort');
            
            if (brands.length > 0) {
                activeFilters.brands = brands;
                brands.forEach(brand => {
                    const checkbox = document.querySelector(`input[value="${brand}"].brand-checkbox`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            if (priceRange) {
                activeFilters.priceRange = priceRange;
                const radio = document.querySelector(`input[value="${priceRange}"][name="priceRange"]`);
                if (radio) radio.checked = true;
            }
            
            if (rating) {
                activeFilters.rating = rating;
                const radio = document.querySelector(`input[value="${rating}"][name="rating"]`);
                if (radio) radio.checked = true;
            }
            
            if (onSale === 'true') {
                activeFilters.promotions.push('onSale');
                const checkbox = document.querySelector('input[name="onSale"]');
                if (checkbox) checkbox.checked = true;
            }
            
            if (freeShipping === 'true') {
                activeFilters.promotions.push('freeShipping');
                const checkbox = document.querySelector('input[name="freeShipping"]');
                if (checkbox) checkbox.checked = true;
            }
            
            // Set sort value from URL
            if (sort) {
                const sortSelect = document.querySelector('.product-sort-select');
                if (sortSelect) {
                    sortSelect.value = sort;
                }
            }
            
            updateActiveFilters();
            
            // Apply initial filters if any exist
            if (brands.length > 0 || priceRange || rating || onSale === 'true' || freeShipping === 'true' || sort) {
                applyFilters();
            }
        });

        // Brand Search Functionality
        function initializeBrandSearch() {
            const brandSearchInput = document.getElementById('brandSearchInput');
            const brandOptions = document.querySelectorAll('.brand-option');
            
            if (brandSearchInput && brandOptions.length > 0) {
                brandSearchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    
                    brandOptions.forEach(option => {
                        const brandName = option.getAttribute('data-brand');
                        const isVisible = brandName.includes(searchTerm);
                        option.style.display = isVisible ? 'flex' : 'none';
                    });
                });
            }
        }

        function attachFilterListeners() {
            // Brand checkboxes
            document.querySelectorAll('.brand-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleBrandFilter);
            });

            // Price range radio buttons
            document.querySelectorAll('input[name="priceRange"]').forEach(radio => {
                radio.addEventListener('change', handlePriceFilter);
            });

            // Rating radio buttons
            document.querySelectorAll('input[name="rating"]').forEach(radio => {
                radio.addEventListener('change', handleRatingFilter);
            });

            // Promotion checkboxes
            document.querySelectorAll('input[name="onSale"], input[name="freeShipping"]').forEach(checkbox => {
                checkbox.addEventListener('change', handlePromotionFilter);
            });

            // Custom price inputs
            const priceMinInput = document.getElementById('priceMin');
            const priceMaxInput = document.getElementById('priceMax');
            if (priceMinInput) priceMinInput.addEventListener('change', handleCustomPriceFilter);
            if (priceMaxInput) priceMaxInput.addEventListener('change', handleCustomPriceFilter);
        }

        function handleBrandFilter(event) {
            const brand = event.target.value;
            if (event.target.checked) {
                activeFilters.brands.push(brand);
            } else {
                activeFilters.brands = activeFilters.brands.filter(b => b !== brand);
            }
            updateActiveFilters();
            applyFilters();
        }

        function handlePriceFilter(event) {
            if (event.target.checked) {
                activeFilters.priceRange = event.target.value;
                // Clear custom price inputs
                const priceMinInput = document.getElementById('priceMin');
                const priceMaxInput = document.getElementById('priceMax');
                if (priceMinInput) priceMinInput.value = '';
                if (priceMaxInput) priceMaxInput.value = '';
            }
            updateActiveFilters();
            applyFilters();
        }

        function handleRatingFilter(event) {
            if (event.target.checked) {
                activeFilters.rating = event.target.value;
            }
            updateActiveFilters();
            applyFilters();
        }

        function handlePromotionFilter(event) {
            const promo = event.target.name;
            if (event.target.checked) {
                if (!activeFilters.promotions.includes(promo)) {
                    activeFilters.promotions.push(promo);
                }
            } else {
                activeFilters.promotions = activeFilters.promotions.filter(p => p !== promo);
            }
            updateActiveFilters();
            applyFilters();
        }

        function handleCustomPriceFilter() {
            const minPrice = document.getElementById('priceMin').value;
            const maxPrice = document.getElementById('priceMax').value;
            
            if (minPrice || maxPrice) {
                // Clear radio buttons
                document.querySelectorAll('input[name="priceRange"]').forEach(radio => {
                    radio.checked = false;
                });
                activeFilters.priceRange = `${minPrice || 0}-${maxPrice || 0}`;
            } else {
                activeFilters.priceRange = null;
            }
            updateActiveFilters();
            applyFilters();
        }

        function updateActiveFilters() {
            const activeFiltersContainer = document.getElementById('activeFilters');
            const activeFilterTags = document.getElementById('activeFilterTags');
            const productsActiveFiltersContainer = document.getElementById('productsActiveFilters');
            const productsActiveFilterTags = document.getElementById('productsActiveFilterTags');
            
            let tags = [];
            
            // Brand filters
            if (activeFilters.brands && activeFilters.brands.length > 0) {
                activeFilters.brands.forEach(brand => {
                    tags.push(`<div class="product-active-filter-tag">
                        ${brand}
                        <span class="remove" onclick="removeBrandFilter('${brand}')">×</span>
                    </div>`);
                });
            }
            
            // Price range filter
            if (activeFilters.priceRange) {
                const priceText = getPriceRangeText(activeFilters.priceRange);
                tags.push(`<div class="product-active-filter-tag">
                    ${priceText}
                    <span class="remove" onclick="removePriceFilter()">×</span>
                </div>`);
            }
            
            // Rating filter
            if (activeFilters.rating) {
                tags.push(`<div class="product-active-filter-tag">
                    ${activeFilters.rating}★ trở lên
                    <span class="remove" onclick="removeRatingFilter()">×</span>
                </div>`);
            }
            
            // Promotion filters
            if (activeFilters.promotions && activeFilters.promotions.length > 0) {
                activeFilters.promotions.forEach(promo => {
                    const promoText = promo === 'onSale' ? 'Đang giảm giá' : 'Miễn phí vận chuyển';
                    tags.push(`<div class="product-active-filter-tag">
                        ${promoText}
                        <span class="remove" onclick="removePromotionFilter('${promo}')">×</span>
                    </div>`);
                });
            }
            
            const tagsHTML = tags.join('');
            
            // Update sidebar active filters
            if (activeFiltersContainer && activeFilterTags) {
                if (tags.length > 0) {
                    activeFilterTags.innerHTML = tagsHTML;
                    activeFiltersContainer.style.display = 'block';
                } else {
                    activeFiltersContainer.style.display = 'none';
                }
            }
            
            // Update products content active filters
            if (productsActiveFiltersContainer && productsActiveFilterTags) {
                if (tags.length > 0) {
                    productsActiveFilterTags.innerHTML = tagsHTML;
                    productsActiveFiltersContainer.style.display = 'block';
                } else {
                    productsActiveFiltersContainer.style.display = 'none';
                }
            }
        }
        
        function getPriceRangeText(range) {
            switch (range) {
                case '0-100000': return 'Dưới 100k';
                case '100000-300000': return '100k - 300k';
                case '300000-500000': return '300k - 500k';
                case '500000-1000000': return '500k - 1M';
                case '1000000-0': return 'Trên 1M';
                default: return range;
            }
        }
        
        function removeBrandFilter(brand) {
            activeFilters.brands = activeFilters.brands.filter(b => b !== brand);
            document.querySelector(`input[value="${brand}"].brand-checkbox`).checked = false;
            updateActiveFilters();
            applyFilters();
        }
        
        function removePriceFilter() {
            activeFilters.priceRange = null;
            document.querySelectorAll('input[name="priceRange"]').forEach(radio => radio.checked = false);
            updateActiveFilters();
            applyFilters();
        }
        
        function removeRatingFilter() {
            activeFilters.rating = null;
            document.querySelectorAll('input[name="rating"]').forEach(radio => radio.checked = false);
            updateActiveFilters();
            applyFilters();
        }
        
        function removePromotionFilter(promo) {
            activeFilters.promotions = activeFilters.promotions.filter(p => p !== promo);
            document.querySelector(`input[name="${promo}"]`).checked = false;
            updateActiveFilters();
            applyFilters();
        }

        function clearAllFilters() {
            activeFilters = {
                brands: [],
                priceRange: null,
                rating: null,
                promotions: []
            };
            
            // Clear all form inputs
            document.querySelectorAll('.product-filter-checkbox, .product-filter-radio').forEach(input => {
                input.checked = false;
            });
            
            // Clear price inputs if they exist
            const priceMinInput = document.getElementById('priceMin');
            const priceMaxInput = document.getElementById('priceMax');
            if (priceMinInput) priceMinInput.value = '';
            if (priceMaxInput) priceMaxInput.value = '';
            
            // Reset sort to default
            const sortSelect = document.querySelector('.product-sort-select');
            if (sortSelect) {
                sortSelect.value = 'popular';
            }
            
            // Reset to show all original products
            resetToOriginalProducts();
            
            updateActiveFilters();
            updateURL();
        }
        
        function resetToOriginalProducts() {
            const productGrid = document.querySelector('.product-grid');
            if (productGrid && originalProducts.length > 0) {
                // Clear current grid
                productGrid.innerHTML = '';
                
                // Add all original products back
                originalProducts.forEach(originalProduct => {
                    const clonedProduct = originalProduct.cloneNode(true);
                    clonedProduct.style.display = 'block';
                    productGrid.appendChild(clonedProduct);
                });
                
                // Update product count
                const productsTitle = document.querySelector('.products-title');
                if (productsTitle) {
                    productsTitle.textContent = `Tìm thấy ${originalProducts.length} sản phẩm`;
                }
                
                // Hide no products message
                hideNoProductsMessage();
            }
        }
        
        function applyFilters() {
            // Use original products or current products if original not available
            const productCards = originalProducts.length > 0 ? originalProducts.map(p => p.cloneNode(true)) : Array.from(document.querySelectorAll('.product-card'));
            const sortSelect = document.querySelector('.product-sort-select');
            const currentSort = sortSelect ? sortSelect.value : 'popular';
            
            // Convert to Array for filtering and sorting
            let filteredProducts = Array.from(productCards);
            
            // Check if any filters are active
            const hasActiveFilters = activeFilters.brands.length > 0 || 
                                   activeFilters.priceRange || 
                                   activeFilters.rating || 
                                   activeFilters.promotions.length > 0;
            
            // Apply filters only if there are active filters
            if (hasActiveFilters) {
                filteredProducts = filteredProducts.filter(card => {
                    const productData = getProductDataFromCard(card);
                    
                    // Brand filter
                    if (activeFilters.brands.length > 0) {
                        if (!activeFilters.brands.includes(productData.brand)) {
                            return false;
                        }
                    }
                    
                    // Price filter
                    if (activeFilters.priceRange) {
                        const [minPrice, maxPrice] = activeFilters.priceRange.split('-').map(p => parseInt(p) || 0);
                        if (maxPrice === 0) { // "trên X" case
                            if (productData.price < minPrice) return false;
                        } else if (minPrice === 0) { // "dưới X" case
                            if (productData.price > maxPrice) return false;
                        } else { // "từ X đến Y" case
                            if (productData.price < minPrice || productData.price > maxPrice) return false;
                        }
                    }
                    
                    // Rating filter
                    if (activeFilters.rating) {
                        const minRating = parseFloat(activeFilters.rating);
                        if (productData.rating < minRating) return false;
                    }
                    
                    // Promotion filters
                    if (activeFilters.promotions.includes('onSale') && !productData.isOnSale) {
                        return false;
                    }
                    
                    return true;
                });
            }
            
            // Apply sorting
            filteredProducts = sortProducts(filteredProducts, currentSort);
            
            // Show filtered and sorted products
            const productGrid = document.querySelector('.product-grid');
            if (productGrid) {
                // Clear grid and add filtered products in order
                productGrid.innerHTML = '';
                filteredProducts.forEach(card => {
                    card.style.display = 'block';
                    productGrid.appendChild(card);
                });
            }
            
            // Update product count
            const productsTitle = document.querySelector('.products-title');
            if (productsTitle) {
                productsTitle.textContent = `Tìm thấy ${filteredProducts.length} sản phẩm`;
            }
            
            // Show no products message if needed
            if (filteredProducts.length === 0) {
                showNoProductsMessage();
            } else {
                hideNoProductsMessage();
            }
            
            // Update URL without page reload
            updateURL();
        }
        
        function getProductDataFromCard(card) {
            const brandElement = card.querySelector('.product-brand');
            const priceElement = card.querySelector('.product-current-price');
            const ratingStars = card.querySelectorAll('.product-rating .fa-star.active');
            const saleBadge = card.querySelector('.product-sale-badge');
            
            // Extract price (remove commas and currency)
            let price = 0;
            if (priceElement) {
                const priceText = priceElement.textContent.replace(/[.,đ\s]/g, '');
                price = parseInt(priceText) || 0;
            }
            
            return {
                brand: brandElement ? brandElement.textContent.trim() : '',
                price: price,
                rating: ratingStars ? ratingStars.length : 0,
                isOnSale: !!saleBadge
            };
        }
        
        function sortProducts(products, sortType) {
            return products.sort((a, b) => {
                const aData = getProductDataFromCard(a);
                const bData = getProductDataFromCard(b);
                
                switch (sortType) {
                    case 'price-asc':
                        return aData.price - bData.price;
                    case 'price-desc':
                        return bData.price - aData.price;
                    case 'name-asc':
                        const aName = a.querySelector('.product-name')?.textContent.trim() || '';
                        const bName = b.querySelector('.product-name')?.textContent.trim() || '';
                        return aName.localeCompare(bName);
                    case 'name-desc':
                        const aNameDesc = a.querySelector('.product-name')?.textContent.trim() || '';
                        const bNameDesc = b.querySelector('.product-name')?.textContent.trim() || '';
                        return bNameDesc.localeCompare(aNameDesc);
                    case 'rating':
                        return bData.rating - aData.rating;
                    default: // 'popular'
                        return 0; // Keep original order
                }
            });
        }
        
        function showNoProductsMessage() {
            let noProductsDiv = document.querySelector('.product-no-products');
            const productGrid = document.querySelector('.product-grid');
            
            if (!noProductsDiv && productGrid) {
                noProductsDiv = document.createElement('div');
                noProductsDiv.className = 'product-no-products';
                noProductsDiv.innerHTML = `
                    <i class="fas fa-search"></i>
                    <h3>Không tìm thấy sản phẩm</h3>
                    <p>Không có sản phẩm nào phù hợp với tiêu chí tìm kiếm của bạn.</p>
                    <button class="product-back-to-all-btn" onclick="clearAllFilters()">
                        <i class="fas fa-arrow-left"></i> Xem tất cả sản phẩm
                    </button>
                `;
                // Insert after product-grid
                productGrid.parentNode.insertBefore(noProductsDiv, productGrid.nextSibling);
            }
            
            if (noProductsDiv) {
                noProductsDiv.style.display = 'block';
            }
        }
        
        function hideNoProductsMessage() {
            const noProductsDiv = document.querySelector('.product-no-products');
            if (noProductsDiv) {
                noProductsDiv.style.display = 'none';
            }
        }
        
        function updateURL() {
            const params = new URLSearchParams(window.location.search);
            
            // Clear previous filter params
            params.delete('brand');
            params.delete('priceRange');
            params.delete('rating');
            params.delete('onSale');
            params.delete('freeShipping');
            
            // Add current filters
            activeFilters.brands.forEach(brand => {
                params.append('brand', brand);
            });
            
            if (activeFilters.priceRange) {
                params.set('priceRange', activeFilters.priceRange);
            }
            
            if (activeFilters.rating) {
                params.set('rating', activeFilters.rating);
            }
            
            activeFilters.promotions.forEach(promo => {
                params.set(promo, 'true');
            });
            
            // Add sort
            const sortSelect = document.querySelector('.product-sort-select');
            if (sortSelect && sortSelect.value && sortSelect.value !== 'popular') {
                params.set('sort', sortSelect.value);
            } else {
                params.delete('sort');
            }
            
            // Update URL without page reload
            const newUrl = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
            window.history.pushState({}, '', newUrl);
        }
        
        function addToCart(productId) {
            // Add to cart logic here
            console.log('Adding product to cart:', productId);
        }
    </script>
} 