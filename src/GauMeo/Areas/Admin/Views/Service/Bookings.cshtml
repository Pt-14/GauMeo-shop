@model GauMeo.Models.ViewModels.ServiceBookingManagementViewModel
@{
    ViewData["Title"] = "Quản lý đặt lịch dịch vụ";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin/service-management.css" />
    <link rel="stylesheet" href="~/css/admin/booking-management.css" />
}

<div class="page-header">
    <div class="header-content">
        <h1>
            <i class='bx bx-calendar-check'></i>
            Quản lý đặt lịch dịch vụ
        </h1>
    </div>
    <div class="header-actions">
        <a href="@Url.Action("Calendar")" class="btn-admin btn-primary">
            <i class='bx bx-calendar'></i>
            Xem lịch
        </a>
    </div>
</div>

<div class="content-wrapper">
    <!-- Stats Section -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon bg-primary">
                <i class='bx bx-calendar-event'></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@Model.Statistics.TotalBookings</div>
                <div class="stat-label">Tổng lịch đặt</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-warning">
                <i class='bx bx-time'></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@Model.Statistics.PendingBookings</div>
                <div class="stat-label">Chờ xác nhận</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-info">
                <i class='bx bx-check-circle'></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@Model.Statistics.ConfirmedBookings</div>
                <div class="stat-label">Đã xác nhận</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-success">
                <i class='bx bx-check-double'></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@Model.Statistics.CompletedBookings</div>
                <div class="stat-label">Hoàn thành</div>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon bg-success">
                <i class='bx bx-money'></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@Model.Statistics.TotalRevenue.ToString("N0") VNĐ</div>
                <div class="stat-label">Tổng doanh thu</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-info">
                <i class='bx bx-calendar-check'></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@Model.Statistics.TodayBookings</div>
                <div class="stat-label">Hôm nay</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-primary">
                <i class='bx bx-calendar-week'></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@Model.Statistics.WeekBookings</div>
                <div class="stat-label">Tuần này</div>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon bg-warning">
                <i class='bx bx-calendar-x'></i>
            </div>
            <div class="stat-content">
                <div class="stat-number">@Model.Statistics.CancelledBookings</div>
                <div class="stat-label">Đã hủy</div>
            </div>
        </div>
    </div>

    <!-- Search Section -->
    <div class="search-section">
        <form id="searchForm" method="get" class="search-form">
            <div class="search-input">
                <i class='bx bx-search'></i>
                <input type="text" name="SearchTerm" value="@Model.Filters.SearchTerm" 
                       placeholder="Tìm kiếm theo tên khách hàng, số điện thoại, email...">
            </div>
            <div class="search-buttons">
                <button type="submit" class="btn-filter primary">
                    <i class='bx bx-search'></i>
                    Tìm kiếm
                </button>
                <a href="@Url.Action("Bookings")" class="btn-filter secondary">
                    <i class='bx bx-reset'></i>
                    Đặt lại
                </a>
            </div>
        </form>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
        <form id="filterForm" method="get" class="filter-form">
            <div class="filter-group">
                <label>Trạng thái</label>
                <select name="Status" class="form-control">
                    <option value="">Tất cả trạng thái</option>
                    <option value="Pending" selected="@(Model.Filters.Status == "Pending")">Chờ xác nhận</option>
                    <option value="Confirmed" selected="@(Model.Filters.Status == "Confirmed")">Đã xác nhận</option>
                    <option value="InProgress" selected="@(Model.Filters.Status == "InProgress")">Đang thực hiện</option>
                    <option value="Completed" selected="@(Model.Filters.Status == "Completed")">Hoàn thành</option>
                    <option value="Cancelled" selected="@(Model.Filters.Status == "Cancelled")">Đã hủy</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Từ ngày</label>
                <input type="date" name="FromDate" value="@(Model.Filters.FromDate?.ToString("yyyy-MM-dd"))" 
                       class="form-control">
            </div>
            <div class="filter-group">
                <label>Đến ngày</label>
                <input type="date" name="ToDate" value="@(Model.Filters.ToDate?.ToString("yyyy-MM-dd"))" 
                       class="form-control">
            </div>
            <div class="filter-group">
                <label>Loại thú cưng</label>
                <select name="PetType" class="form-control">
                    <option value="">Tất cả thú cưng</option>
                    <option value="dog" selected="@(Model.Filters.PetType == "dog")">Chó</option>
                    <option value="cat" selected="@(Model.Filters.PetType == "cat")">Mèo</option>
                    <option value="other" selected="@(Model.Filters.PetType == "other")">Khác</option>
                </select>
            </div>
            <div class="filter-buttons">
                <button type="submit" class="btn-filter primary">
                    <i class='bx bx-filter-alt'></i>
                    Lọc
                </button>
                <a href="@Url.Action("Bookings")" class="btn-filter secondary">
                    <i class='bx bx-reset'></i>
                    Đặt lại
                </a>
            </div>
        </form>
    </div>

    <!-- Bookings Table -->
    <div class="table-responsive">
        <table class="admin-table" id="bookingsTable">
            <thead>
                <tr>
                    <th class="sortable" data-sort="date">
                        Ngày đặt
                        <i class='bx bx-sort sort-icon'></i>
                    </th>
                    <th class="sortable" data-sort="customer">
                        Khách hàng
                        <i class='bx bx-sort sort-icon'></i>
                    </th>
                    <th>Dịch vụ</th>
                    <th>Thú cưng</th>
                    <th class="sortable" data-sort="status">
                        Trạng thái
                        <i class='bx bx-sort sort-icon'></i>
                    </th>
                    <th>Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var booking in Model.Bookings)
                {
                    <tr class="booking-row" data-id="@booking.Id">
                        <td>
                            <div class="booking-date">
                                <div class="date">@booking.BookingDate.ToString("dd/MM/yyyy")</div>
                                <div class="time">@booking.BookingTime</div>
                            </div>
                        </td>
                        <td>
                            <div class="customer-info">
                                <div class="name">@booking.CustomerName</div>
                                <div class="contact">
                                    <span class="phone">@booking.CustomerPhone</span>
                                    @if (!string.IsNullOrEmpty(booking.CustomerEmail))
                                    {
                                        <span class="email">@booking.CustomerEmail</span>
                                    }
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="service-info">
                                <div class="service-name">@booking.ServiceName</div>
                                <div class="variant-name">@booking.VariantName</div>
                                @if (booking.AddonsNames.Any())
                                {
                                    <div class="addons">
                                        <small>Thêm: @string.Join(", ", booking.AddonsNames)</small>
                                    </div>
                                }
                                <div class="price">@booking.EstimatedPrice.ToString("N0") VNĐ</div>
                            </div>
                        </td>
                        <td>
                            <div class="pet-info">
                                <div class="pet-name">@booking.PetName</div>
                                <div class="pet-details">
                                    <span class="type">@(booking.PetType == "dog" ? "Chó" : booking.PetType == "cat" ? "Mèo" : "Khác")</span>
                                    @if (!string.IsNullOrEmpty(booking.PetBreed))
                                    {
                                        <span class="breed">@booking.PetBreed</span>
                                    }
                                    @if (!string.IsNullOrEmpty(booking.PetSize))
                                    {
                                        <span class="size">@booking.PetSize</span>
                                    }
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="status-badge @booking.Status.ToLower()">
                                @(booking.Status switch
                                {
                                    "Pending" => "Chờ xác nhận",
                                    "Confirmed" => "Đã xác nhận",
                                    "InProgress" => "Đang thực hiện",
                                    "Completed" => "Hoàn thành",
                                    "Cancelled" => "Đã hủy",
                                    _ => booking.Status
                                })
                            </div>
                            @if (booking.Status == "Confirmed" || booking.Status == "Completed")
                            {
                                <div class="status-time">
                                    @if (booking.ConfirmedAt.HasValue)
                                    {
                                        <small>Xác nhận: @booking.ConfirmedAt.Value.ToString("dd/MM HH:mm")</small>
                                    }
                                    @if (booking.CompletedAt.HasValue)
                                    {
                                        <small>Hoàn thành: @booking.CompletedAt.Value.ToString("dd/MM HH:mm")</small>
                                    }
                                </div>
                            }
                        </td>
                        <td>
                            <div class="action-buttons">
                                <a href="@Url.Action("BookingDetails", new { id = booking.Id })" 
                                   class="action-btn view-btn" title="Xem chi tiết">
                                    <i class='bx bx-show'></i>
                                </a>
                                @if (booking.Status != "Cancelled" && booking.Status != "Completed")
                                {
                                    <div class="dropdown">
                                        <button class="action-btn status-btn" title="Cập nhật trạng thái">
                                            <i class='bx bx-transfer-alt'></i>
                                        </button>
                                        <div class="dropdown-menu">
                                            @if (booking.Status == "Pending")
                                            {
                                                <button onclick="updateBookingStatus(@booking.Id, 'Confirmed')" class="dropdown-item">
                                                    <i class='bx bx-check text-success'></i>
                                                    Xác nhận
                                                </button>
                                                <button onclick="updateBookingStatus(@booking.Id, 'Cancelled')" class="dropdown-item">
                                                    <i class='bx bx-x text-danger'></i>
                                                    Hủy
                                                </button>
                                            }
                                            else if (booking.Status == "Confirmed")
                                            {
                                                <button onclick="updateBookingStatus(@booking.Id, 'InProgress')" class="dropdown-item">
                                                    <i class='bx bx-play text-info'></i>
                                                    Bắt đầu
                                                </button>
                                                <button onclick="updateBookingStatus(@booking.Id, 'Cancelled')" class="dropdown-item">
                                                    <i class='bx bx-x text-danger'></i>
                                                    Hủy
                                                </button>
                                            }
                                            else if (booking.Status == "InProgress")
                                            {
                                                <button onclick="updateBookingStatus(@booking.Id, 'Completed')" class="dropdown-item">
                                                    <i class='bx bx-check-double text-success'></i>
                                                    Hoàn thành
                                                </button>
                                                <button onclick="updateBookingStatus(@booking.Id, 'Cancelled')" class="dropdown-item">
                                                    <i class='bx bx-x text-danger'></i>
                                                    Hủy
                                                </button>
                                            }
                                        </div>
                                    </div>
                                }
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    @if (Model.Bookings.Any())
    {
        <div class="pagination">
            @{
                var prevDisabled = Model.Filters.PageNumber == 1 ? "disabled" : "";
                var nextDisabled = Model.Filters.PageNumber >= Math.Ceiling((double)Model.Statistics.TotalBookings / Model.Filters.PageSize) ? "disabled" : "";
            }

            <a asp-action="Bookings"
               asp-route-pageNumber="@(Model.Filters.PageNumber - 1)"
               asp-route-searchTerm="@Model.Filters.SearchTerm"
               asp-route-status="@Model.Filters.Status"
               asp-route-fromDate="@Model.Filters.FromDate?.ToString("yyyy-MM-dd")"
               asp-route-toDate="@Model.Filters.ToDate?.ToString("yyyy-MM-dd")"
               asp-route-petType="@Model.Filters.PetType"
               class="btn-admin btn-secondary @prevDisabled">
                <i class='bx bx-chevron-left'></i>
                Trước
            </a>

            <span class="page-info">
                Trang @Model.Filters.PageNumber / @Math.Ceiling((double)Model.Statistics.TotalBookings / Model.Filters.PageSize)
            </span>

            <a asp-action="Bookings"
               asp-route-pageNumber="@(Model.Filters.PageNumber + 1)"
               asp-route-searchTerm="@Model.Filters.SearchTerm"
               asp-route-status="@Model.Filters.Status"
               asp-route-fromDate="@Model.Filters.FromDate?.ToString("yyyy-MM-dd")"
               asp-route-toDate="@Model.Filters.ToDate?.ToString("yyyy-MM-dd")"
               asp-route-petType="@Model.Filters.PetType"
               class="btn-admin btn-secondary @nextDisabled">
                Sau
                <i class='bx bx-chevron-right'></i>
            </a>
        </div>
    }
    else
    {
        <div class="no-data">
            <i class='bx bx-calendar-x'></i>
            <p>Không có lịch đặt nào</p>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            var token = $('input[name="__RequestVerificationToken"]').val();

            // Update booking status
            window.updateBookingStatus = function(id, status) {
                if (!confirm('Bạn có chắc muốn cập nhật trạng thái?')) {
                    return;
                }

                $.ajax({
                    url: '@Url.Action("UpdateBookingStatus")',
                    type: 'POST',
                    data: {
                        id: id,
                        status: status,
                        __RequestVerificationToken: token
                    },
                    success: function(response) {
                        if (response.success) {
                            location.reload();
                        } else {
                            alert(response.message || 'Đã có lỗi xảy ra. Vui lòng thử lại.');
                        }
                    },
                    error: function() {
                        alert('Đã có lỗi xảy ra. Vui lòng thử lại.');
                    }
                });
            };

            // Sorting
            $('.sortable').click(function() {
                var sortBy = $(this).data('sort');
                var currentOrder = '@Model.Filters.SortOrder' || 'asc';
                var newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

                window.location.href = updateQueryStringParameter(window.location.href, 'sortBy', sortBy);
                window.location.href = updateQueryStringParameter(window.location.href, 'sortOrder', newOrder);
            });

            function updateQueryStringParameter(uri, key, value) {
                var re = new RegExp("([?&])" + key + "=.*?(&|$)", "i");
                var separator = uri.indexOf('?') !== -1 ? "&" : "?";
                if (uri.match(re)) {
                    return uri.replace(re, '$1' + key + "=" + value + '$2');
                }
                else {
                    return uri + separator + key + "=" + value;
                }
            }

            // Show active sort direction
            var sortBy = '@Model.Filters.SortBy';
            var sortOrder = '@Model.Filters.SortOrder';
            
            if (sortBy && sortOrder) {
                var th = $('th[data-sort="' + sortBy + '"]');
                th.addClass(sortOrder);
            }

            // Dropdown menu
            $('.status-btn').click(function(e) {
                e.stopPropagation();
                $(this).next('.dropdown-menu').toggleClass('show');
            });

            $(document).click(function() {
                $('.dropdown-menu').removeClass('show');
            });
        });
    </script>
}

@Html.AntiForgeryToken() 