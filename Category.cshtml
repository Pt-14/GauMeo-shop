@{
    ViewData["Title"] = ViewBag.Title;
    var products = ViewBag.Products as List<dynamic>;
    var categoryName = ViewBag.CategoryName as string;
    var category = ViewBag.Category as string;
    var animalType = ViewBag.AnimalType as string;
    var parentCategoryName = ViewBag.ParentCategoryName as string;
    var parentCategoryUrl = ViewBag.ParentCategoryUrl as string;
    var animalPageUrl = ViewBag.AnimalPageUrl as string;
    var animalPageName = ViewBag.AnimalPageName as string;
    var brands = ViewBag.Brands as List<string>;
    var currentFilters = ViewBag.CurrentFilters;
}

@section Styles {
    <link rel="stylesheet" href="~/css/product-index.css" asp-append-version="true" />
}

<div class="product-index-container">
    <div class="breadcrumb">
        <a href="/Home/Index">Trang chủ</a> / 
        <a href="@animalPageUrl">@animalPageName</a> /
        <a href="@parentCategoryUrl">@parentCategoryName</a> /
        <span>@categoryName</span>
    </div>
    
    <div class="product-index-header">
        <h1 class="product-index-title">@ViewBag.Title</h1>
        <div class="product-index-subtitle">
            <span>Khám phá bộ sưu tập @categoryName.ToLower() chất lượng cao được tuyển chọn đặc biệt cho @(animalType == "dog" ? "chó" : "mèo") cưng của bạn.</span>
        </div>
    </div>

    <!-- Mobile Filter Toggle -->
    <button class="product-mobile-filter-toggle" onclick="toggleFilters()">
        <i class="fas fa-filter"></i> Bộ lọc sản phẩm
    </button>

    <!-- Main Layout with Left Sidebar -->
    <div class="product-main-layout">
        <!-- Left Sidebar Filters -->
        <div class="product-filters-sidebar" id="filtersSidebar">
            <h3 class="product-filters-title">
                <i class="fas fa-filter"></i> Bộ lọc sản phẩm
            </h3>
            
            <button class="product-clear-filters-btn" onclick="clearAllFilters()">
                <i class="fas fa-times"></i> Xóa tất cả bộ lọc
            </button>
        
        <form id="filterForm" method="get">
            <input type="hidden" name="category" value="@category" />
                
                <!-- Brand Filter -->
                <div class="product-filter-section">
                    <h4 class="product-filter-section-title">
                        <i class="fas fa-tag"></i> Thương hiệu
                    </h4>
                    <div class="product-brand-search">
                        <input type="text" class="product-brand-search-input" id="brandSearchInput" placeholder="Tìm thương hiệu..." autocomplete="off">
                    </div>
                    <div class="product-brand-options" id="brandOptions">
                        <div class="product-filter-options">
                            @if (brands != null)
                            {
                                @foreach (var brand in brands)
                                {
                                    <label class="product-filter-option brand-option" data-brand="@brand.ToLower()">
                                        <input type="checkbox" name="brands" value="@brand" class="product-filter-checkbox brand-checkbox">
                                        <span class="product-filter-label-text">@brand</span>
                                        <span class="product-filter-count">(3)</span>
                                    </label>
                                }
                            }
                        </div>
                    </div>
                </div>
                
                <!-- Price Range Filter -->
                <div class="product-filter-section">
                    <h4 class="product-filter-section-title">
                        <i class="fas fa-dollar-sign"></i> Khoảng giá
                    </h4>
                    <div class="product-filter-options">
                        <label class="product-filter-option">
                            <input type="radio" name="priceRange" value="0-100000" class="product-filter-radio">
                            <span class="product-filter-label-text">Dưới 100.000đ</span>
                            <span class="product-filter-count">(8)</span>
                        </label>
                        <label class="product-filter-option">
                            <input type="radio" name="priceRange" value="100000-300000" class="product-filter-radio">
                            <span class="product-filter-label-text">100.000đ - 300.000đ</span>
                            <span class="product-filter-count">(12)</span>
                        </label>
                        <label class="product-filter-option">
                            <input type="radio" name="priceRange" value="300000-500000" class="product-filter-radio">
                            <span class="product-filter-label-text">300.000đ - 500.000đ</span>
                            <span class="product-filter-count">(7)</span>
                        </label>
                        <label class="product-filter-option">
                            <input type="radio" name="priceRange" value="500000-1000000" class="product-filter-radio">
                            <span class="product-filter-label-text">500.000đ - 1.000.000đ</span>
                            <span class="product-filter-count">(5)</span>
                        </label>
                        <label class="product-filter-option">
                            <input type="radio" name="priceRange" value="1000000-0" class="product-filter-radio">
                            <span class="product-filter-label-text">Trên 1.000.000đ</span>
                            <span class="product-filter-count">(3)</span>
                        </label>
                    </div>
                    <div class="product-price-range-inputs">
                        <input type="number" placeholder="Từ" class="product-price-input" id="priceMin">
                        <span class="product-price-separator">-</span>
                        <input type="number" placeholder="Đến" class="product-price-input" id="priceMax">
                    </div>
                </div>
                
                <!-- Rating Filter -->
                <div class="product-filter-section">
                    <h4 class="product-filter-section-title">
                        <i class="fas fa-star"></i> Đánh giá
                    </h4>
                    <div class="product-filter-options">
                        <label class="product-rating-option">
                            <input type="radio" name="rating" value="4.5" class="product-filter-radio">
                            <div class="product-rating-stars">
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                            </div>
                            <span class="product-filter-label-text">4.5★ trở lên</span>
                        </label>
                        <label class="product-rating-option">
                            <input type="radio" name="rating" value="4.0" class="product-filter-radio">
                            <div class="product-rating-stars">
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star empty">★</span>
                            </div>
                            <span class="product-filter-label-text">4.0★ trở lên</span>
                        </label>
                        <label class="product-rating-option">
                            <input type="radio" name="rating" value="3.5" class="product-filter-radio">
                            <div class="product-rating-stars">
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star">★</span>
                                <span class="product-rating-star empty">★</span>
                                <span class="product-rating-star empty">★</span>
                            </div>
                            <span class="product-filter-label-text">3.5★ trở lên</span>
                        </label>
                    </div>
                </div>

                <!-- Promotion Filter -->
                <div class="product-filter-section">
                    <h4 class="product-filter-section-title">
                        <i class="fas fa-percent"></i> Khuyến mãi
                    </h4>
                    <div class="product-filter-options">
                        <label class="product-filter-option">
                            <input type="checkbox" name="onSale" value="true" class="product-filter-checkbox">
                            <span class="product-filter-label-text">Đang giảm giá</span>
                            <span class="product-filter-count">(5)</span>
                        </label>
                        <label class="product-filter-option">
                            <input type="checkbox" name="freeShipping" value="true" class="product-filter-checkbox">
                            <span class="product-filter-label-text">Miễn phí vận chuyển</span>
                            <span class="product-filter-count">(3)</span>
                        </label>
                    </div>
                </div>

                <!-- Active Filters -->
                <div class="product-active-filters" id="activeFilters">
                    <div class="product-active-filters-title">Bộ lọc đang áp dụng:</div>
                    <div class="product-active-filter-tags" id="activeFilterTags">
                        <!-- Active filter tags will be inserted here by JavaScript -->
                    </div>
                </div>
            </form>
        </div>

        <!-- Products Content -->
        <div class="product-content">
            <div class="product-back-navigation">
                <a href="@parentCategoryUrl" class="product-back-btn">
                    <i class="fas fa-arrow-left"></i> Quay lại @parentCategoryName
                </a>
            </div>

            <div class="product-header">
                <div class="product-info">
                    <h2 class="products-title">Tìm thấy @products.Count sản phẩm</h2>
                    <p class="product-description">Các sản phẩm @categoryName.ToLower() chất lượng được lựa chọn kỹ lưỡng</p>
                    <div class="product-content-active-filters">
                        <div class="product-active-filters" id="productsActiveFilters">
                            <div class="product-active-filters-title">Đang lọc theo:</div>
                            <div class="product-active-filter-tags" id="productsActiveFilterTags">
                                <!-- Active filter tags will be inserted here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="product-controls">
                    <div class="product-sort-controls">
                        <label>Sắp xếp theo:</label>
                        <select name="sort" class="product-sort-select" onchange="applyFilters()">
                            <option value="popular">Phổ biến nhất</option>
                            <option value="price-asc">Giá tăng dần</option>
                            <option value="price-desc">Giá giảm dần</option>
                            <option value="name-asc">Tên A-Z</option>
                            <option value="name-desc">Tên Z-A</option>
                            <option value="rating">Đánh giá cao nhất</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Products Grid -->
            @if (products != null && products.Count > 0)
            {
                <div class="product-grid">
                @foreach (var product in products)
                {
                    <div class="product-card" data-product-id="@product.Id">
                        <div class="product-image">
                            <img src="@product.Image" alt="@product.Name" loading="lazy">
                            @if (product.IsOnSale)
                            {
                                <div class="product-sale-badge">-@product.DiscountPercent%</div>
                            }
                            <div class="product-actions-overlay">
                                <button class="product-quick-view-btn" title="Xem nhanh">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="product-add-to-wishlist-btn" title="Yêu thích">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>
                        </div>
                        <div class="product-info">
                            <div class="product-brand">@product.Brand</div>
                            <h3 class="product-name">@product.Name</h3>
                            <div class="product-rating">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <i class="fas fa-star @(i <= product.Rating ? "active" : "")"></i>
                                }
                                <span class="product-rating-text">(@product.Rating)</span>
                            </div>
                            <div class="product-price">
                                @if (product.IsOnSale)
                                {
                                    <span class="product-original-price">@product.Price.ToString("N0")đ</span>
                                    <span class="product-current-price">@((product.Price * (100 - product.DiscountPercent) / 100).ToString("N0"))đ</span>
                                }
                                else
                                {
                                    <span class="product-current-price">@product.Price.ToString("N0")đ</span>
                                }
                            </div>
                            <button class="product-add-to-cart-btn" onclick="addToCart(@product.Id)">
                                <i class="fas fa-shopping-cart"></i> Thêm vào giỏ
                            </button>
                        </div>
                    </div>
                }
                </div>
            }
            else
            {
                <div class="product-no-products">
                    <i class="fas fa-search"></i>
                    <h3>Không tìm thấy sản phẩm</h3>
                    <p>Không có sản phẩm nào trong danh mục @categoryName.ToLower() phù hợp với tiêu chí tìm kiếm của bạn.</p>
                    <a href="@parentCategoryUrl" class="product-back-to-all-btn">
                        <i class="fas fa-arrow-left"></i> Quay lại @parentCategoryName
                    </a>
                </div>
            }
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Filter logic with validation - Same as Index.cshtml
        let activeFilters = {
            brands: [],
            priceRange: null,
            rating: null,
            promotions: []
        };

        // Initialize filters from current state
        document.addEventListener('DOMContentLoaded', function() {
            updateActiveFilters();
            attachFilterListeners();
            initializeBrandSearch();
            
            // Initialize from URL parameters if any
            const urlParams = new URLSearchParams(window.location.search);
            const brands = urlParams.getAll('brand');
            const priceRange = urlParams.get('priceRange');
            const rating = urlParams.get('rating');
            const onSale = urlParams.get('onSale');
            const freeShipping = urlParams.get('freeShipping');
            
            if (brands.length > 0) {
                activeFilters.brands = brands;
                brands.forEach(brand => {
                    const checkbox = document.querySelector(`input[value="${brand}"].brand-checkbox`);
                    if (checkbox) checkbox.checked = true;
                });
            }
            
            if (priceRange) {
                activeFilters.priceRange = priceRange;
                const radio = document.querySelector(`input[value="${priceRange}"][name="priceRange"]`);
                if (radio) radio.checked = true;
            }
            
            if (rating) {
                activeFilters.rating = rating;
                const radio = document.querySelector(`input[value="${rating}"][name="rating"]`);
                if (radio) radio.checked = true;
            }
            
            if (onSale === 'true') {
                activeFilters.promotions.push('onSale');
                const checkbox = document.querySelector('input[name="onSale"]');
                if (checkbox) checkbox.checked = true;
            }
            
            if (freeShipping === 'true') {
                activeFilters.promotions.push('freeShipping');
                const checkbox = document.querySelector('input[name="freeShipping"]');
                if (checkbox) checkbox.checked = true;
            }
            
            updateActiveFilters();
        });

        // Brand Search Functionality
        function initializeBrandSearch() {
            const brandSearchInput = document.getElementById('brandSearchInput');
            const brandOptions = document.querySelectorAll('.brand-option');
            
            if (brandSearchInput && brandOptions.length > 0) {
                brandSearchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase().trim();
                    
                    brandOptions.forEach(option => {
                        const brandName = option.getAttribute('data-brand');
                        const isVisible = brandName.includes(searchTerm);
                        option.style.display = isVisible ? 'flex' : 'none';
                    });
                });
            }
        }

        function attachFilterListeners() {
            // Brand checkboxes
            document.querySelectorAll('.brand-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleBrandFilter);
            });

            // Price range radio buttons
            document.querySelectorAll('input[name="priceRange"]').forEach(radio => {
                radio.addEventListener('change', handlePriceFilter);
            });

            // Rating radio buttons
            document.querySelectorAll('input[name="rating"]').forEach(radio => {
                radio.addEventListener('change', handleRatingFilter);
            });

            // Promotion checkboxes
            document.querySelectorAll('input[name="onSale"], input[name="freeShipping"]').forEach(checkbox => {
                checkbox.addEventListener('change', handlePromotionFilter);
            });

            // Custom price inputs
            const priceMinInput = document.getElementById('priceMin');
            const priceMaxInput = document.getElementById('priceMax');
            if (priceMinInput) priceMinInput.addEventListener('change', handleCustomPriceFilter);
            if (priceMaxInput) priceMaxInput.addEventListener('change', handleCustomPriceFilter);
        }

        function handleBrandFilter(event) {
            const brand = event.target.value;
            if (event.target.checked) {
                activeFilters.brands.push(brand);
            } else {
                activeFilters.brands = activeFilters.brands.filter(b => b !== brand);
            }
            updateActiveFilters();
            applyFilters();
        }

        function handlePriceFilter(event) {
            if (event.target.checked) {
                activeFilters.priceRange = event.target.value;
                // Clear custom price inputs
                const priceMinInput = document.getElementById('priceMin');
                const priceMaxInput = document.getElementById('priceMax');
                if (priceMinInput) priceMinInput.value = '';
                if (priceMaxInput) priceMaxInput.value = '';
            }
            updateActiveFilters();
            applyFilters();
        }

        function handleRatingFilter(event) {
            if (event.target.checked) {
                activeFilters.rating = event.target.value;
            }
            updateActiveFilters();
            applyFilters();
        }

        function handlePromotionFilter(event) {
            const promo = event.target.name;
            if (event.target.checked) {
                if (!activeFilters.promotions.includes(promo)) {
                    activeFilters.promotions.push(promo);
                }
            } else {
                activeFilters.promotions = activeFilters.promotions.filter(p => p !== promo);
            }
            updateActiveFilters();
            applyFilters();
        }

        function handleCustomPriceFilter() {
            const priceMinInput = document.getElementById('priceMin');
            const priceMaxInput = document.getElementById('priceMax');
            
            if (!priceMinInput || !priceMaxInput) return;
            
            const minPrice = priceMinInput.value;
            const maxPrice = priceMaxInput.value;
            
            if (minPrice || maxPrice) {
                // Clear radio buttons
                document.querySelectorAll('input[name="priceRange"]').forEach(radio => {
                    radio.checked = false;
                });
                activeFilters.priceRange = `${minPrice || 0}-${maxPrice || 0}`;
            } else {
                activeFilters.priceRange = null;
            }
            updateActiveFilters();
            applyFilters();
        }

        function updateActiveFilters() {
            const activeFiltersContainer = document.getElementById('activeFilters');
            const activeFilterTags = document.getElementById('activeFilterTags');
            const productsActiveFiltersContainer = document.getElementById('productsActiveFilters');
            const productsActiveFilterTags = document.getElementById('productsActiveFilterTags');
            
            let tags = [];
            
            // Brand filters
            if (activeFilters.brands && activeFilters.brands.length > 0) {
                activeFilters.brands.forEach(brand => {
                    tags.push(`<div class="product-active-filter-tag">
                        ${brand}
                        <span class="remove" onclick="removeBrandFilter('${brand}')">×</span>
                    </div>`);
                });
            }
            
            // Price range filter
            if (activeFilters.priceRange) {
                const priceText = getPriceRangeText(activeFilters.priceRange);
                tags.push(`<div class="product-active-filter-tag">
                    ${priceText}
                    <span class="remove" onclick="removePriceFilter()">×</span>
                </div>`);
            }
            
            // Rating filter
            if (activeFilters.rating) {
                tags.push(`<div class="product-active-filter-tag">
                    ${activeFilters.rating}★ trở lên
                    <span class="remove" onclick="removeRatingFilter()">×</span>
                </div>`);
            }
            
            // Promotion filters
            if (activeFilters.promotions && activeFilters.promotions.length > 0) {
                activeFilters.promotions.forEach(promo => {
                    const promoText = promo === 'onSale' ? 'Đang giảm giá' : 'Miễn phí vận chuyển';
                    tags.push(`<div class="product-active-filter-tag">
                        ${promoText}
                        <span class="remove" onclick="removePromotionFilter('${promo}')">×</span>
                    </div>`);
                });
            }
            
            const tagsHTML = tags.join('');
            
            // Update sidebar active filters
            if (activeFiltersContainer && activeFilterTags) {
                if (tags.length > 0) {
                    activeFilterTags.innerHTML = tagsHTML;
                    activeFiltersContainer.style.display = 'block';
                } else {
                    activeFiltersContainer.style.display = 'none';
                }
            }
            
            // Update products content active filters
            if (productsActiveFiltersContainer && productsActiveFilterTags) {
                if (tags.length > 0) {
                    productsActiveFilterTags.innerHTML = tagsHTML;
                    productsActiveFiltersContainer.style.display = 'block';
                } else {
                    productsActiveFiltersContainer.style.display = 'none';
                }
            }
        }
        
        function getPriceRangeText(range) {
            switch (range) {
                case '0-100000': return 'Dưới 100k';
                case '100000-300000': return '100k - 300k';
                case '300000-500000': return '300k - 500k';
                case '500000-1000000': return '500k - 1M';
                case '1000000-0': return 'Trên 1M';
                default: return range;
            }
        }
        
        function removeBrandFilter(brand) {
            activeFilters.brands = activeFilters.brands.filter(b => b !== brand);
            document.querySelector(`input[value="${brand}"].brand-checkbox`).checked = false;
            updateActiveFilters();
            applyFilters();
        }
        
        function removePriceFilter() {
            activeFilters.priceRange = null;
            document.querySelectorAll('input[name="priceRange"]').forEach(radio => radio.checked = false);
            updateActiveFilters();
            applyFilters();
        }
        
        function removeRatingFilter() {
            activeFilters.rating = null;
            document.querySelectorAll('input[name="rating"]').forEach(radio => radio.checked = false);
            updateActiveFilters();
            applyFilters();
        }
        
        function removePromotionFilter(promo) {
            activeFilters.promotions = activeFilters.promotions.filter(p => p !== promo);
            document.querySelector(`input[name="${promo}"]`).checked = false;
            updateActiveFilters();
            applyFilters();
        }

        function clearAllFilters() {
            activeFilters = {
                brands: [],
                priceRange: null,
                rating: null,
                promotions: []
            };
            
            // Clear all form inputs
            document.querySelectorAll('.product-filter-checkbox, .product-filter-radio').forEach(input => {
                input.checked = false;
            });
            
            // Clear price inputs if they exist
            const priceMinInput = document.getElementById('priceMin');
            const priceMaxInput = document.getElementById('priceMax');
            if (priceMinInput) priceMinInput.value = '';
            if (priceMaxInput) priceMaxInput.value = '';
            
            // Reset sort to default
            const sortSelect = document.querySelector('.product-sort-select');
            if (sortSelect) {
                sortSelect.value = 'popular';
            }
            
            updateActiveFilters();
            
            // Make AJAX request to get all products without filters
            const currentUrl = new URL(window.location);
            const params = new URLSearchParams();
            params.append('category', '@category'); // Keep only the category parameter
            currentUrl.search = params.toString();
            
            // Show loading state
            const productsGrid = document.querySelector('.product-grid');
            const productsTitle = document.querySelector('.products-title');
            if (productsGrid) {
                productsGrid.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i><br>Đang tải sản phẩm...</div>';
            }
            
            fetch(currentUrl.toString(), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                // Parse the response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Update products grid
                const newProductsGrid = doc.querySelector('.product-grid');
                const newProductsTitle = doc.querySelector('.products-title');
                
                if (newProductsGrid && productsGrid) {
                    // Remove any existing no-products message
                    const noProductsDiv = document.querySelector('.product-no-products');
                    if (noProductsDiv) {
                        noProductsDiv.remove();
                    }
                    
                    // Show the products grid and update its content
                    productsGrid.style.display = 'grid';
                    productsGrid.innerHTML = newProductsGrid.innerHTML;
                }
                
                // Update products count
                if (newProductsTitle && productsTitle) {
                    productsTitle.textContent = newProductsTitle.textContent;
                }
                
                // Update URL without page reload
                window.history.pushState({}, '', currentUrl.toString());
            })
            .catch(error => {
                console.error('Error clearing filters:', error);
                // Fallback to page reload if AJAX fails
                window.location.href = currentUrl.toString();
            });
        }
        
        function applyFilters() {
            const formData = new FormData();
            
            // Add category (required for category page)
            formData.append('category', '@category');
            
            // Add brands
            activeFilters.brands.forEach(brand => {
                formData.append('brand', brand);
            });
            
            // Add price range
            if (activeFilters.priceRange) {
                formData.append('priceRange', activeFilters.priceRange);
            }
            
            // Add rating
            if (activeFilters.rating) {
                formData.append('rating', activeFilters.rating);
            }
            
            // Add promotions
            activeFilters.promotions.forEach(promo => {
                formData.append(promo, 'true');
            });
            
            // Add sort
            const sortSelect = document.querySelector('.product-sort-select');
            if (sortSelect && sortSelect.value) {
                formData.append('sort', sortSelect.value);
            }
            
            // AJAX request instead of page reload
            const params = new URLSearchParams();
            for (const [key, value] of formData.entries()) {
                params.append(key, value);
            }
            
            // Show loading state
            const productsGrid = document.querySelector('.product-grid');
            const productsTitle = document.querySelector('.products-title');
            if (productsGrid) {
                productsGrid.innerHTML = '<div style="text-align: center; padding: 50px; color: #666;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 15px;"></i><br>Đang tải sản phẩm...</div>';
            }
            
            // Make AJAX request
            const currentUrl = new URL(window.location);
            currentUrl.search = params.toString();
            
            fetch(currentUrl.toString(), {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.text())
            .then(html => {
                // Parse the response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                // Update products grid
                const newProductsGrid = doc.querySelector('.product-grid');
                const newProductsTitle = doc.querySelector('.products-title');
                const newNoProducts = doc.querySelector('.product-no-products');
                
                if (newProductsGrid && productsGrid) {
                    // Remove any existing no-products message
                    const noProductsDiv = document.querySelector('.product-no-products');
                    if (noProductsDiv) {
                        noProductsDiv.remove();
                    }
                    
                    // Show the products grid and update its content
                    productsGrid.style.display = 'grid';
                    productsGrid.innerHTML = newProductsGrid.innerHTML;
                } else if (newNoProducts) {
                    // If no products found, replace the grid with the no-products message
                    const contentDiv = productsGrid.parentElement;
                    productsGrid.style.display = 'none';
                    
                    // Check if no-products message already exists
                    let noProductsDiv = document.querySelector('.product-no-products');
                    if (!noProductsDiv) {
                        noProductsDiv = document.createElement('div');
                        noProductsDiv.className = 'product-no-products';
                        contentDiv.appendChild(noProductsDiv);
                    }
                    noProductsDiv.innerHTML = newNoProducts.innerHTML;
                }
                
                // Update products count
                if (newProductsTitle && productsTitle) {
                    productsTitle.textContent = newProductsTitle.textContent;
                }
                
                // Update URL without page reload
                window.history.pushState({}, '', currentUrl.toString());
            })
            .catch(error => {
                console.error('Error applying filters:', error);
                // Fallback to page reload if AJAX fails
                window.location.href = currentUrl.toString();
            });
        }
        
        function addToCart(productId) {
            // Add to cart logic here
            console.log('Adding product to cart:', productId);
        }
        
        function toggleFilters() {
            const sidebar = document.getElementById('filtersSidebar');
            if (sidebar) {
                sidebar.classList.toggle('show');
            }
        }
    </script>
}