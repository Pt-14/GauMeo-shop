@model IEnumerable<dynamic>
@{
    ViewData["Title"] = "Lịch dịch vụ";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin/service-management.css" />
    <link rel="stylesheet" href="~/css/admin/booking-management.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" />
}

<div class="page-header">
    <div class="header-content">
        <h1>
            <i class='bx bx-calendar'></i>
            Lịch dịch vụ
        </h1>
        <div class="breadcrumb">
            <a href="@Url.Action("Index", "Home", new { area = "Admin" })">Trang chủ</a>
            <span>/</span>
            <a href="@Url.Action("Bookings", "Service")">Quản lý đặt lịch</a>
            <span>/</span>
            <span>Lịch</span>
        </div>
    </div>
    <div class="header-actions">
        <a href="@Url.Action("Bookings")" class="btn-admin btn-secondary">
            <i class='bx bx-arrow-back'></i>
            Quay lại
        </a>
    </div>
</div>

<div class="content-wrapper">
    <div id="calendar"></div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chi tiết đặt lịch</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div id="eventDetails"></div>
                <div id="statusActions" class="mt-3"></div>
            </div>
            <div class="modal-footer">
                <a href="#" id="viewDetailsLink" class="btn-admin btn-primary">
                    <i class='bx bx-show'></i>
                    Xem chi tiết
                </a>
                <button type="button" class="btn-admin btn-secondary" data-dismiss="modal">
                    <i class='bx bx-x'></i>
                    Đóng
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales-all.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                locale: 'vi',
                events: @Html.Raw(Json.Serialize(Model)),
                eventClick: function(info) {
                    var event = info.event;
                    var description = event.extendedProps.description.replace(/\n/g, '<br>');
                    var status = event.extendedProps.status;
                    
                    $('#eventDetails').html(`
                        <div class="event-details">
                            <div class="status-badge ${status.toLowerCase()}">
                                ${getStatusText(status)}
                            </div>
                            <div class="event-info">
                                <p><strong>Thời gian:</strong> ${formatDateTime(event.start)} - ${formatDateTime(event.end)}</p>
                                <p>${description}</p>
                            </div>
                        </div>
                    `);

                    // Add status update buttons
                    var statusActions = '';
                    if (status !== 'Cancelled' && status !== 'Completed') {
                        statusActions = '<div class="status-actions mt-3">';
                        if (status === 'Pending') {
                            statusActions += `
                                <button onclick="updateBookingStatus('${event.id}', 'Confirmed')" class="btn-admin btn-success mr-2">
                                    <i class='bx bx-check'></i> Xác nhận
                                </button>
                                <button onclick="updateBookingStatus('${event.id}', 'Cancelled')" class="btn-admin btn-danger">
                                    <i class='bx bx-x'></i> Hủy
                                </button>
                            `;
                        } else if (status === 'Confirmed') {
                            statusActions += `
                                <button onclick="updateBookingStatus('${event.id}', 'InProgress')" class="btn-admin btn-info mr-2">
                                    <i class='bx bx-play'></i> Bắt đầu
                                </button>
                                <button onclick="updateBookingStatus('${event.id}', 'Cancelled')" class="btn-admin btn-danger">
                                    <i class='bx bx-x'></i> Hủy
                                </button>
                            `;
                        } else if (status === 'InProgress') {
                            statusActions += `
                                <button onclick="updateBookingStatus('${event.id}', 'Completed')" class="btn-admin btn-success mr-2">
                                    <i class='bx bx-check-double'></i> Hoàn thành
                                </button>
                                <button onclick="updateBookingStatus('${event.id}', 'Cancelled')" class="btn-admin btn-danger">
                                    <i class='bx bx-x'></i> Hủy
                                </button>
                            `;
                        }
                        statusActions += '</div>';
                    }
                    $('#statusActions').html(statusActions);
                    
                    $('#viewDetailsLink').attr('href', '@Url.Action("BookingDetails", "Service")/' + event.id);
                    $('#eventModal').modal('show');
                },
                eventClassNames: function(arg) {
                    return ['calendar-event', arg.event.extendedProps.className];
                }
            });
            calendar.render();
        });

        function getStatusText(status) {
            switch (status) {
                case 'Pending': return 'Chờ xác nhận';
                case 'Confirmed': return 'Đã xác nhận';
                case 'InProgress': return 'Đang thực hiện';
                case 'Completed': return 'Hoàn thành';
                case 'Cancelled': return 'Đã hủy';
                default: return status;
            }
        }

        function formatDateTime(date) {
            return new Date(date).toLocaleString('vi-VN', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function updateBookingStatus(id, status) {
            if (!confirm('Bạn có chắc muốn cập nhật trạng thái?')) {
                return;
            }

            var token = $('input[name="__RequestVerificationToken"]').val();
            
            $.ajax({
                url: '@Url.Action("UpdateBookingStatus", "Service", new { area = "Admin" })',
                type: 'POST',
                data: { 
                    id: id, 
                    status: status,
                    __RequestVerificationToken: token
                },
                success: function(response) {
                    if (response.success) {
                        $('#eventModal').modal('hide');
                        location.reload();
                    } else {
                        alert(response.message || 'Đã có lỗi xảy ra. Vui lòng thử lại.');
                    }
                },
                error: function() {
                    alert('Đã có lỗi xảy ra. Vui lòng thử lại.');
                }
            });
        }
    </script>
}

@Html.AntiForgeryToken() 