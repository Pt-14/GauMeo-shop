@model GauMeo.Models.ViewModels.ProductCreateViewModel
@{
    ViewData["Title"] = "Thêm sản phẩm mới";
    Layout = "~/Areas/Admin/Views/Shared/_AdminLayout.cshtml";
}

<div class="main-content">
    <!-- Header Section -->
    <div class="admin-card">
        <div class="card-header-admin">
            <h4 class="card-title">
                <i class='bx bx-plus'></i>
                Thêm sản phẩm mới
            </h4>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Home", new { area = "Admin" })">Dashboard</a></li>
                    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Product", new { area = "Admin" })">Sản phẩm</a></li>
                    <li class="breadcrumb-item active">Thêm mới</li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Form Section -->
    <form asp-action="Create" method="post" enctype="multipart/form-data" class="product-form">
        <div asp-validation-summary="All" class="alert alert-danger"></div>
        
        <div class="form-grid">
            <!-- Basic Information Card -->
            <div class="admin-card">
                <div class="card-header-admin">
                    <h5 class="card-title">
                        <i class='bx bx-info-circle'></i>
                        Thông tin cơ bản
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group col-md-12">
                            <label asp-for="Name" class="form-label">Tên sản phẩm <span class="required">*</span></label>
                            <input asp-for="Name" class="form-control" placeholder="Nhập tên sản phẩm">
                            <span asp-validation-for="Name" class="text-danger"></span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-md-12">
                            <label asp-for="ShortDescription" class="form-label">Mô tả ngắn</label>
                            <textarea asp-for="ShortDescription" class="form-control" rows="3" placeholder="Mô tả ngắn về sản phẩm"></textarea>
                            <span asp-validation-for="ShortDescription" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label asp-for="CategoryId" class="form-label">Danh mục <span class="required">*</span></label>
                            <select asp-for="CategoryId" class="form-control" asp-items="ViewBag.CategoryId">
                                <option value="">Chọn danh mục</option>
                            </select>
                            <span asp-validation-for="CategoryId" class="text-danger"></span>
                        </div>
                        <div class="form-group col-md-6">
                            <label asp-for="BrandId" class="form-label">Thương hiệu <span class="required">*</span></label>
                            <div class="brand-search-container">
                                <input type="text" id="brandSearch" class="form-control" placeholder="Tìm kiếm thương hiệu..." />
                                <select asp-for="BrandId" class="form-control mt-2" asp-items="ViewBag.BrandId" id="brandSelect">
                                    <option value="">Chọn thương hiệu</option>
                                </select>
                            </div>
                            <span asp-validation-for="BrandId" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label asp-for="AnimalType" class="form-label">Loại thú cưng <span class="required">*</span></label>
                            <select asp-for="AnimalType" class="form-control" asp-items="ViewBag.AnimalTypes" required>
                                <option value="">Chọn loại thú cưng</option>
                            </select>
                            <span asp-validation-for="AnimalType" class="text-danger"></span>
                        </div>
                        <div class="form-group col-md-6">
                            <label asp-for="Tags" class="form-label">Tags</label>
                            <input asp-for="Tags" class="form-control" placeholder="Nhập các tag, phân cách bằng dấu phẩy">
                            <span asp-validation-for="Tags" class="text-danger"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pricing Information Card -->
            <div class="admin-card">
                <div class="card-header-admin">
                    <h5 class="card-title">
                        <i class='bx bx-money'></i>
                        Thông tin giá
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label asp-for="OriginalPrice" class="form-label">Giá gốc <span class="required">*</span></label>
                            <div class="input-group">
                                <input asp-for="OriginalPrice" class="form-control" type="number" step="1000" min="0" placeholder="0">
                                <div class="input-group-append">
                                    <span class="input-group-text">₫</span>
                                </div>
                            </div>
                            <span asp-validation-for="OriginalPrice" class="text-danger"></span>
                        </div>
                        <div class="form-group col-md-6">
                            <label asp-for="DiscountPercent" class="form-label">Giảm giá (%)</label>
                            <div class="input-group">
                                <input asp-for="DiscountPercent" class="form-control" type="number" min="0" max="100" placeholder="0">
                                <div class="input-group-append">
                                    <span class="input-group-text">%</span>
                                </div>
                            </div>
                            <span asp-validation-for="DiscountPercent" class="text-danger"></span>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group col-md-12">
                            <div class="price-preview">
                                <strong>Giá bán cuối cùng: <span id="finalPrice">0₫</span></strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Inventory & Status Card -->
            <div class="admin-card">
                <div class="card-header-admin">
                    <h5 class="card-title">
                        <i class='bx bx-package'></i>
                        Kho hàng & Trạng thái
                    </h5>
                </div>
                <div class="card-body">
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label asp-for="StockQuantity" class="form-label">Số lượng tồn kho <span class="required">*</span></label>
                            <input asp-for="StockQuantity" class="form-control" type="number" min="0" placeholder="0">
                            <span asp-validation-for="StockQuantity" class="text-danger"></span>
                        </div>
                        <div class="form-group col-md-6">
                            <label asp-for="PopularityScore" class="form-label">Điểm phổ biến</label>
                            <input asp-for="PopularityScore" class="form-control" type="number" min="0" placeholder="0">
                            <span asp-validation-for="PopularityScore" class="text-danger"></span>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group col-md-12">
                            <div class="checkbox-group">
                                <div class="form-check">
                                    <input asp-for="IsActive" class="form-check-input" type="checkbox" checked>
                                    <label asp-for="IsActive" class="form-check-label">Hoạt động</label>
                                </div>
                                <div class="form-check">
                                    <input asp-for="IsFeatured" class="form-check-input" type="checkbox">
                                    <label asp-for="IsFeatured" class="form-check-label">Sản phẩm nổi bật</label>
                                </div>
                                <div class="form-check">
                                    <input asp-for="IsOnSale" class="form-check-input" type="checkbox">
                                    <label asp-for="IsOnSale" class="form-check-label">Đang giảm giá</label>
                                </div>
                                <div class="form-check">
                                    <input asp-for="FreeShipping" class="form-check-input" type="checkbox">
                                    <label asp-for="FreeShipping" class="form-check-label">Miễn phí vận chuyển</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Product Images Section -->
        <div class="admin-card">
            <div class="card-header-admin">
                <h5 class="card-title">
                    <i class='bx bx-image'></i>
                    Hình ảnh sản phẩm
                </h5>
                <button type="button" class="btn-admin btn-outline-primary btn-sm" onclick="addImageRow()">
                    <i class='bx bx-plus'></i>
                    Thêm hình ảnh
                </button>
            </div>
            <div class="card-body">
                <div id="images-container">
                    @for (int i = 0; i < Model.ProductImages.Count; i++)
                    {
                        <div class="image-row" data-index="@i">
                            <input type="hidden" asp-for="ProductImages[@i].Id" />
                            <input type="hidden" asp-for="ProductImages[@i].IsDeleted" />
                            
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label class="form-label">Hình ảnh <span class="required">*</span></label>
                                    <div class="image-upload-container">
                                        <input type="file" class="image-file-input" accept="image/*" style="display: none;" />
                                        <button type="button" class="btn btn-outline-primary upload-btn">
                                            <i class='bx bx-image-add'></i>
                                            Chọn hình ảnh
                                        </button>
                                        <div class="image-preview" style="display: none;">
                                            <img src="" alt="Preview" style="max-width: 100px; max-height: 100px; object-fit: cover;" />
                                            <button type="button" class="btn btn-sm btn-danger remove-image-btn">
                                                <i class='bx bx-x'></i>
                                            </button>
                                        </div>
                                        <span class="upload-status"></span>
                                    </div>
                                    <input asp-for="ProductImages[@i].ImageUrl" type="hidden" />
                                    <span asp-validation-for="ProductImages[@i].ImageUrl" class="text-danger"></span>
                                </div>
                                <div class="form-group col-md-4">
                                    <label asp-for="ProductImages[@i].AltText" class="form-label">Mô tả ảnh</label>
                                    <input asp-for="ProductImages[@i].AltText" class="form-control" placeholder="Mô tả ngắn cho ảnh" />
                                    <span asp-validation-for="ProductImages[@i].AltText" class="text-danger"></span>
                                </div>
                                <div class="form-group col-md-2">
                                    <label class="form-label">Thao tác</label>
                                    <div class="form-check">
                                        <input asp-for="ProductImages[@i].IsMain" class="form-check-input" type="checkbox" />
                                        <label asp-for="ProductImages[@i].IsMain" class="form-check-label">Ảnh chính</label>
                                    </div>
                                    <button type="button" class="btn btn-danger btn-sm mt-1" onclick="removeImageRow(this)">
                                        <i class='bx bx-trash'></i>
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" asp-for="ProductImages[@i].DisplayOrder" value="@(i + 1)" />
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Product Descriptions Section -->
        <div class="admin-card">
            <div class="card-header-admin">
                <h5 class="card-title">
                    <i class='bx bx-detail'></i>
                    Mô tả chi tiết sản phẩm
                </h5>
                <button type="button" class="btn-admin btn-outline-primary btn-sm" onclick="addDescriptionRow()">
                    <i class='bx bx-plus'></i>
                    Thêm mô tả
                </button>
            </div>
            <div class="card-body">
                <div id="descriptions-container">
                    @for (int i = 0; i < Model.ProductDescriptions.Count; i++)
                    {
                        <div class="description-row" data-index="@i">
                            <input type="hidden" asp-for="ProductDescriptions[@i].Id" />
                            <input type="hidden" asp-for="ProductDescriptions[@i].IsDeleted" />
                            
                            <div class="form-row">
                                <div class="form-group col-md-12">
                                    <label asp-for="ProductDescriptions[@i].Title" class="form-label">Tiêu đề <span class="required">*</span></label>
                                    <input asp-for="ProductDescriptions[@i].Title" class="form-control" placeholder="VD: Thành phần, Hướng dẫn sử dụng, Lợi ích..." />
                                    <span asp-validation-for="ProductDescriptions[@i].Title" class="text-danger"></span>
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-10">
                                    <label asp-for="ProductDescriptions[@i].Content" class="form-label">Nội dung <span class="required">*</span></label>
                                    <textarea asp-for="ProductDescriptions[@i].Content" class="form-control" rows="4" placeholder="Nhập nội dung mô tả chi tiết..."></textarea>
                                    <span asp-validation-for="ProductDescriptions[@i].Content" class="text-danger"></span>
                                </div>
                                <div class="form-group col-md-2">
                                    <label class="form-label">Thao tác</label>
                                    <div class="form-check">
                                        <input asp-for="ProductDescriptions[@i].IsActive" class="form-check-input" type="checkbox" />
                                        <label asp-for="ProductDescriptions[@i].IsActive" class="form-check-label">Hiển thị</label>
                                    </div>
                                    <button type="button" class="btn btn-danger btn-sm mt-1" onclick="removeDescriptionRow(this)">
                                        <i class='bx bx-trash'></i>
                                    </button>
                                </div>
                            </div>
                            <input type="hidden" asp-for="ProductDescriptions[@i].DisplayOrder" value="@(i + 1)" />
                            <hr />
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="admin-card">
            <div class="card-body">
                <div class="form-actions">
                    <button type="submit" class="btn-admin btn-success">
                        <i class='bx bx-save'></i>
                        Lưu sản phẩm
                    </button>
                    <a href="@Url.Action("Index")" class="btn-admin btn-secondary">
                        <i class='bx bx-x'></i>
                        Hủy bỏ
                    </a>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        let imageIndex = @Model.ProductImages.Count;
        let descriptionIndex = @Model.ProductDescriptions.Count;

        // Calculate final price based on original price and discount
        function calculateFinalPrice() {
            const originalPrice = parseFloat(document.getElementById('OriginalPrice').value) || 0;
            const discountPercent = parseFloat(document.getElementById('DiscountPercent').value) || 0;
            const finalPrice = originalPrice * (100 - discountPercent) / 100;
            
            document.getElementById('finalPrice').textContent = finalPrice.toLocaleString('vi-VN') + '₫';
        }

        function addImageRow() {
            const container = document.getElementById('images-container');
            const newRow = `
                <div class="image-row" data-index="${imageIndex}">
                    <input type="hidden" name="ProductImages[${imageIndex}].Id" value="0" />
                    <input type="hidden" name="ProductImages[${imageIndex}].IsDeleted" value="false" />
                    
                    <div class="form-row">
                        <div class="form-group col-md-6">
                            <label class="form-label">Hình ảnh <span class="required">*</span></label>
                            <div class="image-upload-container">
                                <input type="file" class="image-file-input" accept="image/*" style="display: none;" />
                                <button type="button" class="btn btn-outline-primary upload-btn">
                                    <i class='bx bx-image-add'></i>
                                    Chọn hình ảnh
                                </button>
                                <div class="image-preview" style="display: none;">
                                    <img src="" alt="Preview" style="max-width: 100px; max-height: 100px; object-fit: cover;" />
                                    <button type="button" class="btn btn-sm btn-danger remove-image-btn">
                                        <i class='bx bx-x'></i>
                                    </button>
                                </div>
                                <span class="upload-status"></span>
                            </div>
                            <input type="hidden" name="ProductImages[${imageIndex}].ImageUrl" />
                        </div>
                        <div class="form-group col-md-4">
                            <label class="form-label">Mô tả ảnh</label>
                            <input name="ProductImages[${imageIndex}].AltText" class="form-control" placeholder="Mô tả ngắn cho ảnh" />
                        </div>
                        <div class="form-group col-md-2">
                            <label class="form-label">Thao tác</label>
                            <div class="form-check">
                                <input name="ProductImages[${imageIndex}].IsMain" class="form-check-input" type="checkbox" value="true" />
                                <input name="ProductImages[${imageIndex}].IsMain" type="hidden" value="false" />
                                <label class="form-check-label">Ảnh chính</label>
                            </div>
                            <button type="button" class="btn btn-danger btn-sm mt-1" onclick="removeImageRow(this)">
                                <i class='bx bx-trash'></i>
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="ProductImages[${imageIndex}].DisplayOrder" value="${imageIndex + 1}" />
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newRow);
            setupImageUpload(container.lastElementChild);
            imageIndex++;
        }

        function removeImageRow(button) {
            const row = button.closest('.image-row');
            const isDeletedInput = row.querySelector('input[name$=".IsDeleted"]');
            if (isDeletedInput) {
                isDeletedInput.value = 'true';
                row.style.display = 'none';
            } else {
                row.remove();
            }
        }

        function addDescriptionRow() {
            const container = document.getElementById('descriptions-container');
            const newRow = `
                <div class="description-row" data-index="${descriptionIndex}">
                    <input type="hidden" name="ProductDescriptions[${descriptionIndex}].Id" value="0" />
                    <input type="hidden" name="ProductDescriptions[${descriptionIndex}].IsDeleted" value="false" />
                    
                    <div class="form-row">
                        <div class="form-group col-md-12">
                            <label class="form-label">Tiêu đề <span class="required">*</span></label>
                            <input name="ProductDescriptions[${descriptionIndex}].Title" class="form-control" placeholder="VD: Thành phần, Hướng dẫn sử dụng, Lợi ích..." />
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group col-md-10">
                            <label class="form-label">Nội dung <span class="required">*</span></label>
                            <textarea name="ProductDescriptions[${descriptionIndex}].Content" class="form-control" rows="4" placeholder="Nhập nội dung mô tả chi tiết..."></textarea>
                        </div>
                        <div class="form-group col-md-2">
                            <label class="form-label">Thao tác</label>
                            <div class="form-check">
                                <input name="ProductDescriptions[${descriptionIndex}].IsActive" class="form-check-input" type="checkbox" value="true" checked />
                                <input name="ProductDescriptions[${descriptionIndex}].IsActive" type="hidden" value="false" />
                                <label class="form-check-label">Hiển thị</label>
                            </div>
                            <button type="button" class="btn btn-danger btn-sm mt-1" onclick="removeDescriptionRow(this)">
                                <i class='bx bx-trash'></i>
                            </button>
                        </div>
                    </div>
                    <input type="hidden" name="ProductDescriptions[${descriptionIndex}].DisplayOrder" value="${descriptionIndex + 1}" />
                    <hr />
                </div>
            `;
            container.insertAdjacentHTML('beforeend', newRow);
            descriptionIndex++;
        }

        function removeDescriptionRow(button) {
            const row = button.closest('.description-row');
            const isDeletedInput = row.querySelector('input[name$=".IsDeleted"]');
            if (isDeletedInput) {
                isDeletedInput.value = 'true';
                row.style.display = 'none';
            } else {
                row.remove();
            }
        }

        // Image upload functionality
        function setupImageUpload(rowElement) {
            const fileInput = rowElement.querySelector('.image-file-input');
            const uploadBtn = rowElement.querySelector('.upload-btn');
            const preview = rowElement.querySelector('.image-preview');
            const previewImg = rowElement.querySelector('.image-preview img');
            const removeBtn = rowElement.querySelector('.remove-image-btn');
            const hiddenInput = rowElement.querySelector('input[type="hidden"][name*="ImageUrl"]');
            const statusSpan = rowElement.querySelector('.upload-status');

            uploadBtn.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                // Show upload status
                statusSpan.textContent = 'Đang tải lên...';
                statusSpan.style.color = '#007bff';

                // Create FormData
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch('@Url.Action("UploadImage", "Product", new { area = "Admin" })', {
                        method: 'POST',
                        body: formData,
                        headers: {
                            'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                        }
                    });

                    const result = await response.json();
                    
                    if (result.success) {
                        // Update hidden input with image URL
                        hiddenInput.value = result.imageUrl;
                        
                        // Show preview
                        previewImg.src = result.imageUrl;
                        preview.style.display = 'flex';
                        uploadBtn.style.display = 'none';
                        
                        statusSpan.textContent = 'Tải lên thành công';
                        statusSpan.style.color = '#28a745';
                    } else {
                        statusSpan.textContent = result.message || 'Có lỗi xảy ra';
                        statusSpan.style.color = '#dc3545';
                    }
                } catch (error) {
                    statusSpan.textContent = 'Có lỗi xảy ra khi tải lên';
                    statusSpan.style.color = '#dc3545';
                }
            });

            removeBtn.addEventListener('click', () => {
                hiddenInput.value = '';
                preview.style.display = 'none';
                uploadBtn.style.display = 'block';
                fileInput.value = '';
                statusSpan.textContent = '';
            });
        }

        // Brand search functionality
        function setupBrandSearch() {
            const searchInput = document.getElementById('brandSearch');
            const brandSelect = document.getElementById('brandSelect');
            const allOptions = Array.from(brandSelect.options);

            searchInput.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                
                // Clear current options except the first one
                brandSelect.innerHTML = '<option value="">Chọn thương hiệu</option>';
                
                // Filter and add matching options
                allOptions.slice(1).forEach(option => {
                    if (option.text.toLowerCase().includes(searchTerm)) {
                        brandSelect.appendChild(option.cloneNode(true));
                    }
                });
            });

            // When an option is selected, update the search input
            brandSelect.addEventListener('change', (e) => {
                const selectedOption = e.target.options[e.target.selectedIndex];
                if (selectedOption.value) {
                    searchInput.value = selectedOption.text;
                }
            });
        }

        // Add event listeners
        document.getElementById('OriginalPrice').addEventListener('input', calculateFinalPrice);
        document.getElementById('DiscountPercent').addEventListener('input', calculateFinalPrice);

        // Initialize
        calculateFinalPrice();
        setupBrandSearch();
        
        // Setup existing image upload handlers
        document.querySelectorAll('.image-row').forEach(setupImageUpload);
    </script>
} 